<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Flappy Blue — GitHub JSON Hack</title>
  <style>
    /* (keep your existing CSS exactly as before) */
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <header>
        <h1>Flappy Blue</h1>
      </header>

      <canvas id="game" width="360" height="640"></canvas>

      <div class="hud">
        <div id="scoreBox" class="scoreBox">0</div>
        <div id="highBox" class="highBox">HS: 0</div>
      </div>

      <div class="centerOverlay">
        <div class="message" id="overlayBox">
          <div id="stateTitle">Welcome</div>
          <div id="stateHint">Login to start playing</div>
        </div>
      </div>

      <footer>By V</footer>
    </div>

    <!-- Auth Sidebar -->
    <div class="sidebar" id="authSidebar">
      <h2>Login / Register</h2>
      <div class="field"><input id="username" type="text" placeholder="Username"></div>
      <div class="field"><input id="password" type="password" placeholder="Password"></div>
      <div class="actions">
        <button id="loginBtn" class="btn-primary">Login</button>
        <button id="registerBtn" class="btn-ghost">Register</button>
      </div>
      <div id="authMsg" class="note"></div>
      <hr style="margin:15px 0; border:none; border-top:1px solid rgba(2,44,82,0.2)">
      <div class="actions">
        <button id="playBtn" class="btn-primary">Play</button>
        <button id="quitBtn" class="btn-danger">Quit</button>
        <button id="leaderboardBtn" class="btn-ghost">Leaderboard</button>
        <button id="logoutBtn" class="btn-ghost" style="display:none">Logout</button>
      </div>
    </div>

    <!-- Leaderboard Sidebar -->
    <div class="sidebar" id="leaderboardSidebar" style="display:none">
      <h2>Leaderboard</h2>
      <ul id="leaderboardList"></ul>
    </div>
  </div>

  <script>
    const canvas = document.getElementById('game');
    const ctx = canvas.getContext('2d');

    /* ---------------- GITHUB JSON CONFIG ---------------- */
    const GITHUB_TOKEN = "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"; // ⚠️ anyone can see this
    const OWNER = "yednap97";
    const REPO = "FlappyBlue";
    const FILE_PATH = "data/users.json";

    let users = {};
    let usersSha = null;
    let currentUser = null;
    let highScore = 0;

    async function getUsers() {
      const res = await fetch(`https://api.github.com/repos/${OWNER}/${REPO}/contents/${FILE_PATH}`, {
        headers: { Authorization: `token ${GITHUB_TOKEN}` }
      });
      const data = await res.json();
      const content = atob(data.content);
      return { users: JSON.parse(content), sha: data.sha };
    }

    async function saveUsers(users, sha) {
      const content = btoa(JSON.stringify(users, null, 2));
      await fetch(`https://api.github.com/repos/${OWNER}/${REPO}/contents/${FILE_PATH}`, {
        method: "PUT",
        headers: { Authorization: `token ${GITHUB_TOKEN}` },
        body: JSON.stringify({
          message: "Update users.json",
          content,
          sha
        })
      });
    }

    async function loadUsers() {
      const res = await getUsers();
      users = res.users;
      usersSha = res.sha;
    }

    async function saveUsersRemote() {
      await saveUsers(users, usersSha);
      await loadUsers(); // refresh sha after commit
    }

    /* ---------------- PASSWORD HASHING ---------------- */
    async function hashPassword(password) {
      const encoder = new TextEncoder();
      const data = encoder.encode(password);
      const hashBuffer = await crypto.subtle.digest('SHA-256', data);
      const hashArray = Array.from(new Uint8Array(hashBuffer));
      const hashHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
      return hashHex;
    }

    /* ---------------- GAME LOGIC (unchanged) ---------------- */
    let score = 0;
    let running = false;
    let gravity = 0.6;
    let jump = -10;
    let speed = 3;
    let bird = { x:50, y:150, r:12, dy:0 };
    let pipes = [];

    function resetGame(){ bird = { x:50, y:150, r:12, dy:0 }; pipes = []; score = 0; }
    function spawnPipe(){ const top=Math.random()*200+50; const gap=140; const bottom=canvas.height-top-gap; pipes.push({x:canvas.width,w:60,top,bottom,passed:false}); }
    function drawBackground(){ const grd=ctx.createLinearGradient(0,0,0,canvas.height); grd.addColorStop(0,"#cfe9ff"); grd.addColorStop(1,"#6fb8ff"); ctx.fillStyle=grd; ctx.fillRect(0,0,canvas.width,canvas.height); ctx.fillStyle="white"; drawCloud(60,100); drawCloud(200,150); drawCloud(120,250); ctx.fillStyle="rgba(0,0,0,0.05)"; ctx.fillRect(0,canvas.height-30,canvas.width,30);}
    function drawCloud(x,y){ctx.beginPath();ctx.arc(x,y,20,0,Math.PI*2);ctx.arc(x+25,y+10,25,0,Math.PI*2);ctx.arc(x-25,y+10,25,0,Math.PI*2);ctx.fill();}
    function drawBird(){ctx.fillStyle="white";ctx.beginPath();ctx.arc(bird.x,bird.y,bird.r,0,Math.PI*2);ctx.fill();ctx.strokeStyle="#004aad";ctx.lineWidth=2;ctx.stroke();ctx.fillStyle="white";ctx.beginPath();ctx.arc(bird.x+4,bird.y-4,3,0,Math.PI*2);ctx.fill();ctx.fillStyle="black";ctx.beginPath();ctx.arc(bird.x+4,bird.y-4,1.5,0,Math.PI*2);ctx.fill();}
    function drawPipes(){pipes.forEach(p=>{ctx.fillStyle="#1e5cb8";ctx.fillRect(p.x,0,p.w,p.top);ctx.fillRect(p.x,canvas.height-p.bottom,p.w,p.bottom);ctx.fillStyle="#154a96";ctx.fillRect(p.x+p.w-6,0,6,p.top);ctx.fillRect(p.x+p.w-6,canvas.height-p.bottom,6,p.bottom);});}

    const overlayBox=document.getElementById('overlayBox');
    const stateTitle=document.getElementById('stateTitle');
    const stateHint=document.getElementById('stateHint');
    const scoreBox=document.getElementById('scoreBox');
    const highBox=document.getElementById('highBox');

    function update(){
      bird.dy+=gravity;bird.y+=bird.dy;
      if(!pipes.length||pipes[pipes.length-1].x<canvas.width-200){spawnPipe();}
      pipes.forEach(p=>{p.x-=speed;});if(pipes[0]&&pipes[0].x+pipes[0].w<0){pipes.shift();}
      pipes.forEach(p=>{if(!p.passed&&p.x+p.w<bird.x-bird.r){p.passed=true;score++;}});
      if(bird.y+bird.r>=canvas.height||bird.y-bird.r<=0){endGame();return;}
      for(const p of pipes){const inX=bird.x+bird.r>p.x&&bird.x-bird.r<p.x+p.w;const hitTop=bird.y-bird.r<p.top;const hitBottom=bird.y+bird.r>canvas.height-p.bottom;if(inX&&(hitTop||hitBottom)){endGame();return;}}
      drawBackground();drawPipes();drawBird();scoreBox.textContent=score;highBox.textContent='HS: '+highScore;
    }
    function loop(){if(!running)return;update();requestAnimationFrame(loop);}
    function endGame(){running=false;overlayBox.style.display="block";if(score>highScore){highScore=score;if(currentUser){users[currentUser].highScore=highScore;saveUsersRemote();}}stateTitle.textContent='GAME OVER';stateHint.textContent='Score: '+score;}
    function flap(){bird.dy=jump;}
    document.addEventListener('keydown',e=>{if(e.code==='Space'||e.key===' '){e.preventDefault();flap();}});canvas.addEventListener('click',flap);canvas.addEventListener('touchstart',flap,{passive:true});
    function refreshHighBox(){highBox.textContent='HS: '+highScore;}

    /* ---------------- AUTH BUTTONS ---------------- */
    const loginBtn=document.getElementById('loginBtn');
    const registerBtn=document.getElementById('registerBtn');
    const usernameInput=document.getElementById('username');
    const passwordInput=document.getElementById('password');
    const authMsg=document.getElementById('authMsg');
    const playBtn=document.getElementById('playBtn');
    const quitBtn=document.getElementById('quitBtn');
    const logoutBtn=document.getElementById('logoutBtn');
    const leaderboardBtn=document.getElementById('leaderboardBtn');
    const leaderboardSidebar=document.getElementById('leaderboardSidebar');
    const leaderboardList=document.getElementById('leaderboardList');

    loginBtn.addEventListener('click', async ()=>{
      await loadUsers();
      const u=usernameInput.value.trim();const p=passwordInput.value;
      if(!u||!p){authMsg.textContent='Enter a username and password';return;}
      const hashed=await hashPassword(p);
      if(users[u]?.password===hashed){currentUser=u;highScore=users[u].highScore||0;authMsg.textContent='Login successful';logoutBtn.style.display='inline-block';stateTitle.textContent='Welcome, '+currentUser;stateHint.textContent='Press Play to begin.';refreshHighBox();}
      else{authMsg.textContent='Invalid credentials';}
    });

    registerBtn.addEventListener('click', async ()=>{
      await loadUsers();
      const u=usernameInput.value.trim();const p=passwordInput.value;
      if(!u||!p){authMsg.textContent='Enter a username and password';return;}
      if(users[u]){authMsg.textContent='Username already exists';return;}
      const hashed=await hashPassword(p);
      users[u]={password:hashed,highScore:0};
      await saveUsersRemote();
      authMsg.textContent='Registered successfully. Please login';
    });

    logoutBtn.addEventListener('click', ()=>{
      currentUser=null;highScore=0;stateTitle.textContent='Welcome';stateHint.textContent='Login to start playing';logoutBtn.style.display='none';refreshHighBox();running=false;
    });

    leaderboardBtn.addEventListener('click', async ()=>{
      if(leaderboardSidebar.style.display==='none'){await loadUsers();populateLeaderboard();leaderboardSidebar.style.display='block';}
      else{leaderboardSidebar.style.display='none';}
    });

    function populateLeaderboard(){
      leaderboardList.innerHTML='';
      const arr=Object.entries(users).map(([name,data])=>({user:name,score:data.highScore||0})).sort((a,b)=>b.score-a.score);
      if(arr.length===0){leaderboardList.innerHTML='<li>No players yet.</li>';return;}
      arr.forEach((row,i)=>{const li=document.createElement('li');li.textContent=`${i+1}. ${row.user} — ${row.score}`;leaderboardList.appendChild(li);});
    }

    playBtn.addEventListener('click', ()=>{
      if(!currentUser){stateHint.textContent='Login first!';return;}
      resetGame();overlayBox.style.display="none";running=true;requestAnimationFrame(loop);
    });

    quitBtn.addEventListener('click', ()=>{
      running=false;overlayBox.style.display="block";stateTitle.textContent='Goodbye!';stateHint.textContent='Thanks for playing';
    });

    // Load users on startup
    loadUsers();
  </script>
</body>
</html>
